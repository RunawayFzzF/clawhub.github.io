# [MQTT协议－MQTT协议解析（MQTT数据包结构）](http://www.cnblogs.com/zhangyu1024/p/6141818.html)

协议就是通信双方的一个约定，即，表示第1位传输的什么、第2位传输的什么……。在`MQTT`协议中，一个`MQTT`数据包由：`固定头（Fixed header）`、 `可变头（Variable header）`、 `消息体（payload）`三部分构成。

**MQTT 数据包结构**

- `固定头（Fixed header）`，存在于所有`MQTT`数据包中，表示数据包类型及数据包的分组类标识
- `可变头（Variable header）`，存在于部分`MQTT`数据包中，数据包类型决定了可变头是否存在及其具体内容
- `消息体（Payload）`，存在于部分`MQTT`数据包中，表示客户端收到的具体内容

### 1 `MQTT`固定头

`固定头`存在于所有`MQTT`数据包中，其结构如下：

| Bit     | 7           | 6                  | 5    | 4    | 3    | 2    | 1    | 0    |
| ------- | ----------- | ------------------ | ---- | ---- | ---- | ---- | ---- | ---- |
| byte 1  | `MQTT`数据包类型 | 不同类型`MQTT`数据包的具体标识 |      |      |      |      |      |      |
| byte 2… | 剩余长度        |                    |      |      |      |      |      |      |

#### 1.1 `MQTT`数据包类型

**位置：**byte 1, bits 7-4。

相于一个4位的无符号值，类型如下：

| 名称          | 值    | 流方向     | 描述             |
| ----------- | ---- | ------- | -------------- |
| Reserved    | 0    | 不可用     | 保留位            |
| CONNECT     | 1    | 客户端到服务器 | 客户端请求连接到服务器    |
| CONNACK     | 2    | 服务器到客户端 | 连接确认           |
| PUBLISH     | 3    | 双向      | 发布消息           |
| PUBACK      | 4    | 双向      | 发布确认           |
| PUBREC      | 5    | 双向      | 发布收到（保证第1部分到达） |
| PUBREL      | 6    | 双赂      | 发布释放（保证第2部分到达） |
| PUBCOMP     | 7    | 双向      | 发布完成（保证第3部分到达） |
| SUBSCRIBE   | 8    | 客户端到服务器 | 客户端请求订阅        |
| SUBACK      | 9    | 服务器到客户端 | 订阅确认           |
| UNSUBSCRIBE | 10   | 客户端到服务器 | 请求取消订阅         |
| UNSUBACK    | 11   | 服务器到客户端 | 取消订阅确认         |
| PINGREQ     | 12   | 客户端到服务器 | PING请求         |
| PINGRESP    | 13   | 服务器到客户端 | PING应答         |
| DISCONNECT  | 14   | 客户端到服务器 | 中断连接           |
| Reserved    | 15   | 不可用     | 保留位            |

#### 1.2 标识位

**位置：**byte 1, bits 3-0。

在不使用标识位的消息类型中，标识位被做为保留位。如果收到无效的标志时，接收端必须关闭网络连接：

| 数据包         | 标识位          | Bit 3 | Bit 2 | Bit 1 | Bit 0   |
| ----------- | ------------ | ----- | ----- | ----- | ------- |
| CONNECT     | 保留位          | 0     | 0     | 0     | 0       |
| CONNACK     | 保留位          | 0     | 0     | 0     | 0       |
| PUBLISH     | MQTT 3.1.1使用 | DUP1  | QoS2  | QoS2  | RETAIN3 |
| PUBACK      | 保留位          | 0     | 0     | 0     | 0       |
| PUBREC      | 保留位          | 0     | 0     | 0     | 0       |
| PUBREL      | 保留位          | 0     | 0     | 0     | 0       |
| PUBCOMP     | 保留位          | 0     | 0     | 0     | 0       |
| SUBSCRIBE   | 保留位          | 0     | 0     | 0     | 0       |
| SUBACK      | 保留位          | 0     | 0     | 0     | 0       |
| UNSUBSCRIBE | 保留位          | 0     | 0     | 0     | 0       |
| UNSUBACK    | 保留位          | 0     | 0     | 0     | 0       |
| PINGREQ     | 保留位          | 0     | 0     | 0     | 0       |
| PINGRESP    | 保留位          | 0     | 0     | 0     | 0       |
| DISCONNECT  | 保留位          | 0     | 0     | 0     | 0       |

- `DUP`：发布消息的副本。用来在保证消息的可靠传输，如果设置为 1，则在下面的变长中增加MessageId，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。

- ```
  QoS
  ```

  ：发布消息的服务质量，即：保证消息传递的次数

  - `00`：最多一次，即：<=1
  - `01`：至少一次，即：>=1
  - `10`：一次，即：=1
  - `11`：预留

- `RETAIN`： 发布保留标识，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果设有那么推送至当前订阅者后释放。

#### 1.3 剩余长度（Remaining Length）

**位置：**byte 1。

固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的。这一字节是可以扩展，其保存机制，前7位用于保存长度，后一部用做标识。当最后一位为 1时，表示长度不足，需要使用二个字节继续保存。 例如：计算出后面的大小为0

### 2 `MQTT`可变头

`MQTT`数据包中包含一个可变头，它驻位于固定的头和负载之间。可变头的内容因数据包类型而不同，较常的应用是做为包的标识：

| Bit     | 7         | 6    | 5    | 4    | 3    | 2    | 1    | 0    |
| ------- | --------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| byte 1  | 包标签符（MSB） |      |      |      |      |      |      |      |
| byte 2… | 包标签符（LSB） |      |      |      |      |      |      |      |

很多类型数据包中都包括一个2字节的数据包标识字段，这些类型的包有：PUBLISH (QoS > 0)、PUBACK、PUBREC、PUBREL、PUBCOMP、SUBSCRIBE、SUBACK、UNSUBSCRIBE、UNSUBACK

### 3 `Payload`消息体

`Payload`消息体位`MQTT`数据包的第三部分，CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE四种类型的消息 有消息体：

- - `CONNECT`，消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码。
  - `SUBSCRIBE`，消息体内容是一系列的要订阅的主题以及`QoS`。
  - `SUBACK`，消息体内容是服务器对于`SUBSCRIBE`所申请的主题及`QoS`进行确认和回复。
  - ​
  - `UNSUBSCRIBE`，消息体内容是要订阅的主题。